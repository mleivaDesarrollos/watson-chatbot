<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1080, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Prueba de Watson con nueva integración</title>
    <style>
        .bot_response{
            color: brown;
        }
        .user_response{
            color: blue;
        }
        .message-container{
            width: 50%;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <label><input type="text" name="iptMessageFromUser" placeholder="Ingrese mensaje..."></label> <button type="button" id="btnEnviar">Enviar</button>
    <div class="message-container">
        <ul class="message-list">
        
        </ul>
    </div>
    <script>
        const HIDDEN_TAG_NAME = "context";
        const HIDDEN_CONTEXT_TAG = "input[name='" + HIDDEN_TAG_NAME + "']";

        var ajaxCall = function(url, method, callback, data, json){
            var xhr = new XMLHttpRequest();
            xhr.open(method, url);
            // Si el objeto es de tipo json
            if(json == true){
                xhr.setRequestHeader('Content-Type', 'application/json');
            }
            xhr.addEventListener('load', () => {
                if(xhr.status == 200){
                    callback(xhr.response);
                }
            })
            xhr.send(data);
        }

        var send_message_node_api = function(option_message){
            var messageFromUser;      
            // Levantamos el input
            var iptUserMessage = document.querySelector("input[name='iptMessageFromUser']");      
            if(option_message == undefined){                
                // Levantamos el valor del mensaje
                messageFromUser = iptUserMessage.value;
            } else {
                messageFromUser = option_message;
            }
            // Levantamos el contexto almacenado en el documento
            let iptContext =  document.querySelector(HIDDEN_CONTEXT_TAG);
            let context;
            // Validamos si ya esta cargado el contexto
            if(iptContext != undefined) context = iptContext.value;
            // Vaciamos el contenido
            messageFromUser.value = "";
            // Agregamos el mensaje al acumulador de mensajes
            var ulMessages = document.querySelector(".message-list");
            // Creamos una elemento li para sumarlo
            var li_usermessage = document.createElement("li");
            // Asignamos la clase mensaje
            li_usermessage.classList.add("user_response");
            li_usermessage.innerHTML = messageFromUser;
            // Agregamos el elemento al UL
            ulMessages.appendChild(li_usermessage);
            // Disponemos los datos a enviar
            var body = {
                message: messageFromUser,
                context: context
            }
            // Convertimos el body en string
            body = JSON.stringify(body);
            // Vaciamos el contenido del input
            iptUserMessage.value = "";
            // Enviamos la petición por ajax
            ajaxCall('/send', 'post', renderResponse, body, true);
        }

        var renderResponse = function(response){
            // Levantamos el listado
            var ul_messages = document.querySelector(".message-list");
            // Generamos un nuevo elemento de tipo li
            var li_botmessage = document.createElement("li");
            // Parseamos el elemento JSON
            console.log(response);
            var json = JSON.parse(response);
            // Validamos si el mensaje viene con contexto
            if(json.context != undefined) {
                // Levantamos el tag correspondiente al contexto
                var iptContext = document.querySelector(HIDDEN_CONTEXT_TAG);
                // Validamos si la etiqueta fue encontrada
                if(iptContext == undefined) {
                    // Creamos el elemento y lo anexamos
                    iptContext = document.createElement("input");
                    // Configuramos los parametros de valor
                    iptContext.type = "hidden";
                    iptContext.name = HIDDEN_TAG_NAME;
                    // Anexamos la etiqueta
                    document.body.appendChild(iptContext);
                }
                // Guardamos el contexto obtenido en la etiqueta
                iptContext.value = JSON.stringify(json.context);
            }
            console.log(json.messages);
            // Iteramos sobre todos los mensajes recibidos
            json.messages.forEach(message => {                
                // Establecemos las propiedades
                li_botmessage.classList.add("bot_response");                
                // Agregamos el mensaje de respuesta al acumulador de mensajes         
                li_botmessage.innerHTML = message.text;
                ul_messages.appendChild(li_botmessage);
                    
                if(message.type == "option"){                    
                    // Validamos si el mensaje viene con descripción
                    if(message.description != undefined){
                        // Creamos una etiqueta strong
                        var description = document.createElement("strong");
                        // Almacenamos dentro del description
                        description.innerHTML = message.description;
                        // Anexamos el elemento al listado de mensajes
                        ul_messages.appendChild(description);
                        // Agregamos un elemento br
                        ul_messages.appendChild(document.createElement("br"));
                    }
                    // Mostramos las opciones que viajaron con el mensaje
                    message.options.forEach(option => {
                       // Por cada elemento vamos a renderizar una etiqueta a a modo de prueba
                       var optionResponse = document.createElement("a");
                       // Subscribimos el evento click de este nuevo elemento
                       optionResponse.addEventListener("click", e => { 
                           // Prevenimos la accion por defecto
                            e.preventDefault();
                            // Mandamos el mensaje de respuesta
                            send_message_node_api(option.value)
                       });
                       // Indicamos el contenido el mensaje
                       optionResponse.innerHTML = option.description + " <br>";
                       // Anexamos el mensaje al listado
                       ul_messages.appendChild(optionResponse);
                    });                    
                }                
            });
            // Hacemos focus sobre el input
            var iptMessageFromUser = document.querySelector("input[name='iptMessageFromUser']");
            iptMessageFromUser.focus();
        }
        var btnEnviar = document.querySelector("#btnEnviar");
        btnEnviar.addEventListener('click', e => {
            e.preventDefault();
            // Llamamos a la funcion para enviar mensajes
            send_message_node_api();
        });

        // Levantamos el input de mensaje
        var iptUserMessage = document.querySelector("input[name='iptMessageFromUser']");
        // Anexamos el evento keyup
        iptUserMessage.addEventListener("keyup", e => {
            if(e.keyCode == 13) {
                // Detenemos por defecto
                e.preventDefault();
                // Realizmos un click
                btnEnviar.click();
            }
        });

    </script>
</body>
</html>